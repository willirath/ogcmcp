# Pre-release Test Report — v2026.02.5

**Date**: 2026-02-23
**Image under test**: `mitgcm-mcp:latest` (local build)
**Tester**: Claude Sonnet 4.6 (automated via MCP tool calls)

---

## Pass / Fail Summary

| # | Section | Verdict | Blocking? |
|---|---------|---------|-----------|
| 1 | Workflow tool | ✅ PASS | — |
| 2 | Gotcha catalogue (new entries) | ✅ PASS | — |
| 3 | `get_namelist_structure_tool` | ❌ FAIL | Yes |
| 4 | `namelist_to_code` warning | ✅ PASS | — |
| 5 | Query normalisation | ✅ PASS | — |
| 6 | Verification experiments | ❌ FAIL | Yes |
| 7 | Header indexing | ⚠️ PARTIAL FAIL | Yes |
| 8 | Code navigation | ❌ FAIL | Yes |
| 9 | Domain knowledge + Dockerfile template | ⚠️ PARTIAL FAIL | Yes |

**Release verdict: NOT READY — 5 sections have failures.**

---

## Defects

### D1 — BLOCKER: `f90nml` not installed (T6.1)

`list_verification_experiments_tool()` raises:

```
Error executing tool: No module named 'f90nml'
```

The `f90nml` Python package is absent from the runtime image. Add it to
`requirements.txt` (or equivalent) and rebuild.

---

### D2 — BLOCKER: `data.diagnostics` missing from namelist structure (T3.1)

`get_namelist_structure_tool()` returns no entry for `data.diagnostics`.
The diagnostics package namelist file is not registered in the structure map.
All other required top-level keys are present.

---

### D3 — BLOCKER: `get_cpp_requirements_tool("CG3D")` returns extra flags (T8.3)

Expected: `["ALLOW_NONHYDROSTATIC"]`
Got: `["TARGET_NEC_SX", "NONLIN_FRSURF", "ALLOW_NONHYDROSTATIC"]`

`TARGET_NEC_SX` and `NONLIN_FRSURF` appear to be spurious matches.
The extra flags would mislead users into thinking CG3D requires NEC SX
or non-linear free-surface CPP options.

---

### D4 — FAIL: OBCS description too generic (T3.2)

`data.obcs` / `OBCS_PARM01` description is:

> "Package obcs runtime parameters (group 01)."

The test requires it to explicitly mention "open boundary conditions".
All other PARM groups in `data` have informative descriptions; OBCS groups
should follow the same standard.

---

### D5 — FAIL: `search_verification_tool` returns wrong file types and paths (T6.2)

Query: `"nonhydrostatic SIZE.h sNx sNy Nr"`, `top_k=3`

Actual results:
- `hs94.128x64x5/code/CPP_OPTIONS.h`
- `hs94.cs-32x32x5/code/CPP_OPTIONS.h`
- `cheapAML_box/code/CPP_OPTIONS.h`

Expected: paths matching `verification/.../code/SIZE.h` containing Fortran
PARAMETER content.

Two issues: (a) wrong file type — CPP_OPTIONS.h returned instead of SIZE.h;
(b) paths lack the `verification/` prefix that other tools use (compare: T7.1
returns `verification/front_relax/code/SIZE.h` from `search_docs_tool`).
Snippets contain CPP preprocessor directives, not PARAMETER declarations.

Note: T6.3 passes independently — `get_doc_source_tool` can retrieve
`verification/tutorial_rotating_tank/code/SIZE.h` correctly when given the
path directly.

---

### D6 — FAIL: `.h` snippets lack PARAMETER content (T7.1)

`search_docs_tool("MAX_OLX overlap buffer EXCH", top_k=5)` does return `.h`
files (`eesupp/inc/EEBUFF_SCPU.h`, `verification/front_relax/code/SIZE.h`),
satisfying the file-type criterion.

However, all snippets show only the file's opening header comments. The
PARAMETER declarations in SIZE.h begin at line 44; the first-400-character
snippet window never reaches them. No snippet in the result set contains a
Fortran PARAMETER declaration.

Suggested fix: generate snippets from the first substantive (non-comment)
content block, or index section anchors at the PARAMETER statements.

---

### D7 — ADVISORY: `quickstart.build` key lacks genmake2 `-mpi` (T9.3)

Test criterion: "`quickstart.build` contains `-mpi` in the genmake2 invocation"

Actual `quickstart.build` value:
```
docker build -t my_experiment -f Dockerfile.amd64 .
```

The genmake2 `-mpi` invocation is present — but inside `quickstart.dockerfile_amd64`
and `quickstart.dockerfile_arm64`, not in the `build` key itself.

The `--allow-run-as-root` criterion passes (absent from all quickstart output).
`Dockerfile.amd64` and `Dockerfile.arm64` are both referenced correctly (no
`uname`-based arch detection).

Either update the test spec to check `quickstart.dockerfile_amd64` for the
genmake2 `-mpi` line, or move the genmake2 command back into the `build` key.

---

## Detailed Results

### Section 1 — Workflow tool

**T1.1** PASS — `get_workflow_tool()` returns all five keys (`design_experiment`,
`debug_configuration`, `understand_package`, `explore_code`, `validate_incrementally`).
Each entry has `description`, non-empty `steps` list, and `notes`.

**T1.2** PASS — `get_workflow_tool("validate_incrementally")` returns exactly 4 steps.
Stage 2 mentions "nTimeSteps=2" and "dynamic blowup". Stage 3 mentions
`n3dWetPts`, `theta_mean`, `dynstat diagnostics`. Notes include "one component
at a time".

**T1.3** PASS — `get_workflow_tool("design_experiment")`: step 1 =
`list_verification_experiments_tool`, step 2 = `search_verification_tool`,
step 3 = `get_doc_source_tool`. `translate_lab_params_tool` appears in steps.
Notes mention `validate_incrementally`.

**T1.4** PASS — `get_workflow_tool("Design Experiment")` returns identical output
to T1.3. Case normalisation works.

---

### Section 2 — Gotcha catalogue

**T2.1** PASS — `lookup_gotcha_tool("readBinaryPrec float64")` returns 1 entry.
Detail mentions `float64`, `float32`, `.astype('>f4')`, and "no error is raised".

**T2.2** PASS — `lookup_gotcha_tool("numpy dtype input field precision")` returns
the identical entry.

**T2.3** PASS — `lookup_gotcha_tool("CONFIG_CHECK totPhiHyd pressure")` returns 3
entries including the `INCLUDE_PHIHYD_CALCULATION_CODE` entry. Detail mentions
`CPP_OPTIONS.h` and `CONFIG_CHECK`.

**T2.4** PASS — `lookup_gotcha_tool("PACKAGES_CHECK mom_fluxform")` returns entry
about the `gfd` group. Detail shows minimal `packages.conf` with `gfd` on its
own line.

**T2.5** PASS — `lookup_gotcha_tool("SIZE.h MAX_OLX compilation error")` returns
entry mentioning `MAX_OLX`, `MAX_OLY`, `EXCH.h`, and includes a Fortran
PARAMETER block example.

**T2.6** PASS — `lookup_gotcha_tool("-mpi genmake2 single process")` returns entry
about `-mpi` and `genmake2`. Detail states: "MPICH's hydra launcher does NOT
support --allow-run-as-root; omit that flag entirely."

**T2.7** PASS — All four regression queries return ≥1 entry:
`nonhydrostatic`, `rigid lid`, `DIAGNOSTICS_SIZE`, `RBCS relaxation`.

---

### Section 3 — `get_namelist_structure_tool`

**T3.1** FAIL — See D2. `data.diagnostics` absent. All other required keys
present. PARM01–05 in `data` ✓. `EOS_PARM01` in `data.eos` ✓. `EEPARMS`
in `eedata` ✓. All descriptions non-empty ✓. Keys in alphabetical order ✓.

**T3.2** FAIL — See D4. `data`/`PARM01` describes core dynamics correctly.
`data.obcs`/`OBCS_PARM01` description is generic ("Package obcs runtime
parameters (group 01)") and does not mention "open boundary conditions".

---

### Section 4 — `namelist_to_code_tool` warning

**T4.1** PASS — `namelist_to_code_tool("cg3dMaxIters")` returns
`{name: "INI_PARMS", namelist_group: "PARM02"}`. Has `name` key, no `warning`.

**T4.2** PASS — `namelist_to_code_tool("tauX")` returns a single-entry list with
`warning` key. Warning mentions `search_code_tool`, `get_namelist_structure_tool`,
and names `tauX` explicitly.

**T4.3** PASS — `namelist_to_code_tool("uVel")` follows same pattern as T4.2.

---

### Section 5 — Query normalisation

**T5.1** PASS — `search_docs_tool("rigidLid free surface")` top result:
"Non-linear free-surface" (free surface / barotropic solver content). Not
unrelated material.

**T5.2** PASS — `search_docs_tool("no_slip_bottom boundary condition")` first
result: "Sidewall/Bottom Dissipation" — explicitly mentions `no_slip_sides`
and `no_slip_bottom`.

**T5.3** PASS — `search_docs_tool("deltaT CFL time step stability")` returns
time-stepping results (Adams-Bashforth, Crank-Nicolson, barotropic time
stepping). Time step mentioned throughout.

**T5.4** PASS — `search_verification_tool("nonHydrostatic rotating convection")`
returns results from `tutorial_deep_convection` and `tutorial_rotating_tank`.
Snippets contain `.TRUE.`, `#define`, `useDiagnostics` — recognisable namelist
/ CPP content.

---

### Section 6 — Verification experiments

**T6.1** FAIL — See D1. Hard crash on `list_verification_experiments_tool()`.

**T6.2** FAIL — See D5. Returns CPP_OPTIONS.h files without `verification/`
prefix; snippets contain preprocessor directives, not PARAMETER content.

**T6.3** PASS — `get_doc_source_tool("verification/tutorial_rotating_tank/code/SIZE.h",
"SIZE.h")` returns `{file, section, total_lines: 64, offset: 0, lines: [...]}`.
Lines contain full Fortran PARAMETER block with `sNx=30`, `sNy=23`, `Nr=29`,
`MAX_OLX`, `MAX_OLY`. (Path used from test plan example, not from T6.2 results.)

---

### Section 7 — Header file indexing

**T7.1** PARTIAL FAIL — See D6. `.h` files present in results ✓
(`eesupp/inc/EEBUFF_SCPU.h`, `verification/front_relax/code/SIZE.h`).
Snippets show file headers only, no PARAMETER declarations ✗.

**T7.2** PASS — `get_doc_source_tool("model/inc/SIZE.h", "SIZE.h")` returns 71
lines of Fortran including `sNx`, `sNy`, `OLx`, `OLy`, `nSx`, `nSy`, `nPx`,
`nPy`, `Nx`, `Ny`, `Nr` PARAMETER block, plus `MAX_OLX` and `MAX_OLY`.

---

### Section 8 — Code navigation

**T8.1** PASS — `find_subroutines_tool("INI_PARMS")` finds INI_PARMS
(model/src/ini_parms.F, 1617 lines). `get_source_tool("INI_PARMS", limit=20)`
returns first 20 lines correctly.

**T8.2** PASS — `get_callers_tool("CG3D")` returns `[SOLVE_FOR_PRESSURE]`.
Non-empty list.

**T8.3** FAIL — See D3. Expected `["ALLOW_NONHYDROSTATIC"]`; got
`["TARGET_NEC_SX", "NONLIN_FRSURF", "ALLOW_NONHYDROSTATIC"]`.

**T8.4** PASS — `namelist_to_code_tool("deltaT")` returns
`{name: "INI_PARMS", namelist_group: "PARM03"}`. No `warning` key.

---

### Section 9 — Domain knowledge + Dockerfile template

**T9.1** PASS — `translate_lab_params_tool(Lx=0.5, Ly=0.5, depth=0.2, Omega=1.0,
delta_T=5.0, Nx=64, Ny=64, Nz=20)` returns all required keys. `PARM01` has
`f0=2.0`. `PARM04` has `delX=0.0078125`, `delY=0.0078125`, `delZ=0.01`.

**T9.2** PASS — `check_scales_tool(...)` returns `numbers` dict and `flags` list.
No crash. Flags: 3 warnings (aspect ratio, Ekman layer not resolved, CFL > 0.5)
and 1 info (spin-up periods).

**T9.3** PARTIAL FAIL — See D7. `quickstart.build` =
`"docker build -t my_experiment -f Dockerfile.amd64 ."`. No `--allow-run-as-root`
anywhere ✓. No genmake2 or `-mpi` in the `build` key itself ✗ (present in
`dockerfile_amd64` and `dockerfile_arm64`). Both `Dockerfile.amd64` and
`Dockerfile.arm64` referenced ✓. No `uname`-based arch detection ✓.
