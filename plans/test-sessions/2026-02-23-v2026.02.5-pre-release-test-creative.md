# Creative Exploration Notes — v2026.02.5

**Date**: 2026-02-23
**Method**: Unscripted tool use following interesting threads — call chains,
source reading, census queries, cross-references between gotcha catalogue
and actual source.

---

## Round 1

### C1 — Full pressure-solver call chain

`get_callers_tool` applied repeatedly upward from `CG3D`:

```
THE_MODEL_MAIN
  └─ THE_MAIN_LOOP        ← also called by GRDCHK_MAIN (adjoint gradient checks)
       └─ MAIN_DO_LOOP
            └─ FORWARD_STEP   ← also FORWARD_STEP_ATM2D, INNER_DO_LOOP (openad)
                 └─ SOLVE_FOR_PRESSURE
                      └─ CG3D
```

6 levels deep. `GRDCHK_MAIN` reuses `THE_MAIN_LOOP` wholesale for
finite-difference adjoint verification — the gradient check package doesn't
have its own time loop, it calls the real one.

`CALC_DIV_GHAT` (a callee of `SOLVE_FOR_PRESSURE`) has exactly one caller:
`SOLVE_FOR_PRESSURE`. Private utility, never reused.

---

### C2 — Census of `DIAGNOSTICS_FILL` callers

`get_callers_tool("DIAGNOSTICS_FILL")` returns **109 subroutines across
41 distinct packages**. Selected counts:

| Package | Call sites |
|---------|-----------|
| model (core) | 18 |
| seaice | 10 |
| fizhi | 9 |
| gmredi | 7 |
| generic_advdiff | 5 |
| kpp | 4 |
| bling | 4 |
| thsice | 4 |

`DIAGNOSTICS_FILL` is MITgcm's universal observable hook — more widely
connected than any other single subroutine in the codebase. This is what
makes `diagnostics_fill_to_source_tool` powerful: one call name, 109
potential fill sites to search. Even `MYPACKAGE_DIAGNOSTICS_STATE` (the
stub template) is wired in — good documentation practice.

---

### C3 — Gotcha catalogue vs. `CONFIG_CHECK` source

Read `CONFIG_CHECK` (1159 lines) at multiple offsets to cross-check the
gotcha entry claiming it verifies `INCLUDE_PHIHYD_CALCULATION_CODE`.

**Confirmed in source**: runtime abort patterns for `rigidLid AND
implicitFreeSurface`, `nonlinFreeSurf != 0` without `NONLIN_FRSURF`,
`cAdjFreq != 0` without `INCLUDE_CONVECT_CALL`.

**Not confirmed**: `INCLUDE_PHIHYD_CALCULATION_CODE` was not found in
the sections read (offsets 0–350, 600–700). May be in an unread section
or the gotcha entry is approximate. **Flag for verification.**

**Surprise finding**: `EXACT_CONSERV` has been silently retired:

```fortran
#ifndef EXACT_CONSERV
      WRITE(msgBuf,'(2A)') 'CONFIG_CHECK: ',
     &   '#undef EXACT_CONSERV not allowed in CPP_OPTIONS.h'
      ...
     &   ' since CPP option EXACT_CONSERV has been retired'
      errCount = errCount + 1
#endif
```

The flag used to be optional; it is now mandatory. Old `CPP_OPTIONS.h`
files carrying `#undef EXACT_CONSERV` cause a startup abort with a message
that makes no sense unless you know the history. Not in the gotcha catalogue.
**Suggest adding.**

---

### C4 — KPP package flag archaeology

`get_package_flags_tool("kpp")` returns only 3 flags: `KPP_SMOOTH_SHSQ`,
`KPP_SMOOTH_DBLOC`, `KPP_GHAT`. But `get_cpp_requirements_tool("KPP_CALC")`
returns **14 flags** — the full set of CPP guards appearing anywhere in the
701-line subroutine: `ALLOW_KPP`, `ALLOW_DIAGNOSTICS`, `ALLOW_AUTODIFF_TAMC`,
`ALLOW_SHELFICE`, `ALLOW_SALT_PLUME`, `SHORTWAVE_HEATING`,
`KPP_SMOOTH_DENS/VISC/DIFF/DBLOC/SHSQ`, `KPP_ESTIMATE_UREF`,
`KPP_AUTODIFF_EXCESSIVE_STORE`.

The `ghat` array is KPP's non-local heat flux. At offset 200, `ghat` is
loaded with `dbloc` (buoyancy gradient) for smoothing under
`KPP_SMOOTH_DBLOC`, then overwritten by `kppmix` with the actual non-local
transport. `KPP_GHAT` controls whether this counter-gradient flux is applied
to the temperature tendency — it is the most important of the 3 registered
flags despite its terse description.

`KPP_CALC` dates to August 1994 (author comment at file top). 31 years old
and still called every timestep.

---

### C5 — Is `NONLIN_FRSURF` in CG3D's CPP requirements actually wrong?

T8.3 flagged `get_cpp_requirements_tool("CG3D")` returning
`["TARGET_NEC_SX", "NONLIN_FRSURF", "ALLOW_NONHYDROSTATIC"]`.

`NONLIN_FRSURF` appears throughout the pressure solver (confirmed in
CONFIG_CHECK source — it guards `nonlinFreeSurf` checks). It is a real flag
in the solver context. **D3 still stands** for a different reason:
`TARGET_NEC_SX` is a hardware optimisation flag for 1990s NEC SX vector
machines — completely irrelevant to whether a user can compile CG3D.
The tool reports "all flags found anywhere in the translation unit"
rather than "flags that gate this specific subroutine," and `TARGET_NEC_SX`
is the clearest evidence that this distinction matters.

---

### C6 — Where diagnostics actually live in the call tree

`FORWARD_STEP` (1147 lines, 60 callees) does not directly call
`DIAGNOSTICS_FILL` — it delegates to physics routines that do.
A user debugging a missing diagnostic field should not look in
`FORWARD_STEP`; they should trace the call chain from their package's
`_DIAGNOSTICS_STATE` or `_DIAGNOSTICS_FILL` routine.
`diagnostics_fill_to_source_tool` short-circuits this entirely.

---

### C7 — `EXACT_CONSERV` retirement (new gotcha candidate)

Documented under C3 above. Reproducing here for emphasis:

Any `CPP_OPTIONS.h` from before `EXACT_CONSERV` became mandatory will
cause a startup abort. The error message says "CPP option EXACT_CONSERV
has been retired" which is confusing — it means you must now *define* it
(it's no longer optional), not that you should remove it. Users porting
old experiments are the likely victims.

**Recommended gotcha keywords**: `EXACT_CONSERV`, `retired`, `CPP_OPTIONS`,
`startup abort`, `mandatory`.

---

## Round 2

### C8 — One model timestep, three levels deep

`get_callees_tool` on `FORWARD_STEP`, `THERMODYNAMICS`, and `TIMESTEP`:

**`FORWARD_STEP`**: 60 callees — the widest routine examined. Contains the
full coupled model: ocean, atmosphere (`DO_ATMOSPHERIC_PHYS`), sea ice
(implicit via `DO_OCEANIC_PHYS`), biogeochemistry (`GCHEM_FORCING_SEP`),
Shapiro filter, longstep averaging, floats (`FLT_MAIN`), OASIS coupler
(`OASIS_GET`/`OASIS_PUT`), nesting (`NEST_PARENT_IO_1/2`,
`NEST_CHILD_TRANSP`), adjoint (`AUTODIFF_INADMODE_SET/UNSET`), ECCO cost,
checkpoint I/O (`DO_WRITE_PICKUP`).

**`THERMODYNAMICS`** (tracer arm): 16 callees. CFL is monitored here
(`MON_CALC_ADVCFL_GLOB/TILE`) — stability auto-checked as part of normal
tracer integration, not as a separate pass.

**`TIMESTEP`** (momentum arm): 6 callees. Both `ADAMS_BASHFORTH2` and
`ADAMS_BASHFORTH3` appear — compile-time selection via
`#ifdef ALLOW_ADAMSBASHFORTH_3`. `CD_CODE_SCHEME` is the optional
C/D-grid Coriolis discretisation.

Structural picture:
```
FORWARD_STEP
  ├─ THERMODYNAMICS → TEMP_INTEGRATE → GAD_ADVECTION   (tracer spine)
  └─ DYNAMICS → TIMESTEP → ADAMS_BASHFORTH3             (momentum spine)
```
Both spines terminate at narrowly-called utility routines. The wide
orchestration layer is entirely at the top.

---

### C9 — `SEAICE_GROWTH`: largest subroutine in the index

2672 lines. Description: "Update ice thickness and snow depth."

Header inclusions at entry (14 files): `SIZE.h`, `EEPARAMS.h`, `PARAMS.h`,
`DYNVARS.h`, `GRID.h`, `FFIELDS.h`, `SEAICE_SIZE.h`, `SEAICE_PARAMS.h`,
`SEAICE.h`, `SEAICE_TRACER.h`, plus conditional `EXF_PARAM.h`,
`EXF_FIELDS.h` (`ALLOW_EXF`), `SALT_PLUME.h` (`ALLOW_SALT_PLUME`),
`tamc.h` (`ALLOW_AUTODIFF_TAMC`). A routine that grew by accretion —
atmospheric coupling, brine rejection, and adjoint checkpointing bolted on
without factoring out. Classic monolith signature.

---

### C10 — `SHOWFLOPS_INSOLVE`: Cray-era HPC archaeology

Full 101-line source read. Three mutually exclusive performance backends:

1. `TIME_PER_TIMESTEP_SFP` — wall-clock/user/system time per timestep.
   Comment marker `CCE107` = Cray Computer Enterprise modification.
2. `USE_PAPI_FLOPS_SFP` — PAPI hardware counters (Mflop/s, IPC).
3. `USE_PCL_FLOPS_SFP` — PCL performance counter library.

All three require custom CPP flags. `get_package_flags_tool("showflops")`
returns an empty list — the flags are invisible to the index. In a standard
build the routine does nothing at all. Vestigial infrastructure from when
MITgcm ran on Cray vector machines, frozen beside code 20 years newer.

**Tool gap**: packages whose flags aren't registered return empty from
`get_package_flags`. `showflops` is not the only candidate.

---

### C11 — `GAD_ADVECTION`: generic in scheme, not in reuse

`get_callers_tool("GAD_ADVECTION")` returns exactly **3 callers**:
`TEMP_INTEGRATE`, `SALT_INTEGRATE`, `PTRACERS_INTEGRATE`.

At 1097 lines it implements many schemes (upwind, DST2/3, PPM, etc.) under
one interface — but only temperature, salinity, and passive tracers use it.
"Generic" means runtime-selectable scheme, not wide reuse across the codebase.
Every active tracer passes through the same funnel: one call, all schemes
available.

---

### C12 — `ADAMS_BASHFORTH3`: reading the actual coefficients

Full 127-line source. The comments embed the mathematics:

```
gX^{n+1/2} = (1 + α + β) gX^n  -  (α + 2β) gX^{n-1}  +  β gX^{n-2}
```

Two named configurations in the comments:
- `(α, β) = (0.5, 5/12)` → standard AB-3, CFL stability limit **0.724**
- `β = 0.281105` → maximum stability, CFL limit **0.786** ← **not the default**

The maximum-stability β is documented only in source comments. It is not
exposed as a named mode — users who want it must set `beta_AB = 0.281105`
manually in `data &PARM03`. Both `alph_AB` and `beta_AB` are confirmed
PARM03 parameters via `namelist_to_code_tool`.

Startup ramp is explicit in code: first-order at iter 0, AB-2 at iter 1,
AB-3 thereafter — prevents instability when previous time levels are unavailable.

Callers: `TIMESTEP`, `TEMP_INTEGRATE`, `SALT_INTEGRATE`, `CALC_GW`,
`MOM_QUASIHYDROSTATIC` — AB-3 applied consistently across momentum and tracers.

**Suggested gotcha or docs note**: mention the `β = 0.281105` optimum for
users trying to push timestep size.

---

### C13 — `SUBMESO_CALC_PSI`: Fox-Kemper 2008 in Fortran

Full 230-line source read. Implements Fox-Kemper, Ferrari & Hallberg (2008) /
Fox-Kemper et al. (2011) mixed-layer eddy parameterisation as a near-literal
code translation.

**The `5/21` constant** is the vertical structure function coefficient
from Fox-Kemper 2008 Eq. 3:

```fortran
PARAMETER( five_ov21 = 5. _d 0 / 21. _d 0 )
mu_z = ( z2H + 1. _d 0 )**2
mu_z = ( 1. _d 0 - mu_z ) * ( 1. _d 0 + mu_z*five_ov21 )
```

`μ(z) = (1 − (2z/H+1)²)(1 + 5/21·(2z/H+1)²)` — the unique polynomial
that satisfies the paper's boundary conditions and integrates to 1 over
the mixed layer. It is the only hard-coded numerical constant in the routine.

**Equatorial regularisation**: `fcorLoc = sqrt(f² + subMeso_invTau²)`.
Without the `subMeso_invTau` floor, `Ψ ∝ 1/f` diverges at the equator.
Default ~`1.6e-6 s⁻¹` ≈ 1/(7.2 days), from a commented-out line.

**All tunable parameters are in `data.gmredi` (`GM_PARM01`)**:
`subMeso_Ceff` (efficiency factor, ~0.07), `subMeso_invTau`, `subMeso_LfMin`,
`subMeso_Lmax`. Nothing is hard-coded except `5/21`.

Diagnostics output: `SubMesLf` (frontal length scale), `SubMpsiX`,
`SubMpsiY` — all directly discoverable via `diagnostics_fill_to_source_tool`.

---

### C14 — `CD_CODE_SCHEME`: a well-isolated one-caller package

`find_subroutines_tool("CD_CODE_SCHEME")` → `pkg/cd_code`, 240 lines.
Called from exactly one place: `TIMESTEP` (confirmed via C8 callees list).

Implements MITgcm's C/D-grid Coriolis discretisation — computes Coriolis
on the D-grid and averages to the C-grid, reducing grid-scale noise in
potential vorticity without explicit filtering. Enabled by `useCDscheme`
in `data &PARM01`.

Architecturally the opposite of `SHOWFLOPS`: also rarely used, also
one caller, but lives in a proper named package with clean boundaries and
a compile-time guard. The contrast illustrates two different approaches
to optional code isolation in MITgcm.

**Docs gap**: `search_docs_tool("CD scheme Coriolis Crank Nicolson momentum")`
returns Adams-Bashforth sections, not the CD scheme docs. The package is
not well-indexed under user-facing search terms.

---

## Issues surfaced

| ID | Category | Description |
|----|----------|-------------|
| — | Verify | PHIHYD gotcha claims CONFIG_CHECK check — not found in sections read |
| — | New gotcha | `EXACT_CONSERV` retirement causes startup abort on old CPP_OPTIONS.h |
| — | New docs note | AB-3 `β=0.281105` optimum not surfaced anywhere outside source comments |
| — | Tool gap | `get_package_flags` returns empty for `showflops` (and likely other packages) |
| — | Search gap | `search_docs_tool` does not surface CD scheme docs under expected terms |
| D3 (confirmed) | Bug | `get_cpp_requirements_tool("CG3D")` returns `TARGET_NEC_SX` — spurious hardware flag |
