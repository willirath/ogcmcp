# Pre-release test plan: v2026.02.5

**Image under test**: `mitgcm-mcp:latest` (local build, not yet pushed)
**Install for this session**:
```bash
claude mcp add --transport stdio --scope user mitgcm -- \
  docker run --rm -i mitgcm-mcp:latest
```
Or edit `.mcp.json` in the repo root to `"args": ["run", "--rm", "-i", "mitgcm-mcp:latest"]`.

**Purpose**: Verify every new v2026.02.5 feature before tagging and pushing.
Work through each numbered test, call the tool, check the listed criteria.

---

## 1. Workflow tool

### T1.1 — All workflows returned
```
get_workflow_tool()
```
✓ Dict has keys: `design_experiment`, `debug_configuration`,
  `understand_package`, `explore_code`, `validate_incrementally`
✓ Each entry has `description`, `steps` (non-empty list), `notes`

### T1.2 — validate_incrementally (new in v2026.02.5)
```
get_workflow_tool("validate_incrementally")
```
✓ Returns `{"validate_incrementally": {...}}`
✓ `steps` has exactly 4 entries (Stage 1–4)
✓ Stage 2 purpose mentions "nTimeSteps=2" and "dynamic blowup"
✓ Stage 3 purpose mentions "n3dWetPts", "theta_mean", "dynstat"
✓ Notes contain entry about "one component at a time"

### T1.3 — design_experiment (tutorial-first, rewritten in v2026.02.5)
```
get_workflow_tool("design_experiment")
```
✓ Step 1 tool: `list_verification_experiments_tool`
✓ Step 2 tool: `search_verification_tool`
✓ Step 3 tool: `get_doc_source_tool`
✓ `translate_lab_params_tool` appears in steps
✓ Notes mention `validate_incrementally`

### T1.4 — Case normalisation
```
get_workflow_tool("Design Experiment")
```
✓ Returns same result as T1.3

---

## 2. Gotcha catalogue (5 new entries in v2026.02.5)

### T2.1 — readBinaryPrec / float64 mismatch
```
lookup_gotcha_tool("readBinaryPrec float64")
```
✓ Returns ≥1 result
✓ `detail` mentions `float64`, `float32`, `.astype('>f4')`
✓ `detail` notes "silent wrong results" / no error raised

### T2.2 — Same entry via different keyword
```
lookup_gotcha_tool("numpy dtype input field precision")
```
✓ Same entry as T2.1 returned

### T2.3 — INCLUDE_PHIHYD_CALCULATION_CODE
```
lookup_gotcha_tool("CONFIG_CHECK totPhiHyd pressure")
```
✓ Returns entry mentioning `INCLUDE_PHIHYD_CALCULATION_CODE`
✓ `detail` mentions `CPP_OPTIONS.h` and `CONFIG_CHECK`

### T2.4 — packages.conf gfd group
```
lookup_gotcha_tool("PACKAGES_CHECK mom_fluxform")
```
✓ Returns entry mentioning `gfd` group
✓ `detail` shows minimal packages.conf with `gfd` on its own line

### T2.5 — SIZE.h MAX_OLX / MAX_OLY
```
lookup_gotcha_tool("SIZE.h MAX_OLX compilation error")
```
✓ Returns entry mentioning `MAX_OLX`, `MAX_OLY`, and `EXCH.h`
✓ `detail` includes Fortran PARAMETER block example

### T2.6 — -mpi flag for NP=1
```
lookup_gotcha_tool("-mpi genmake2 single process")
```
✓ Returns entry about `-mpi` and `genmake2`
✓ `detail` notes MPICH hydra does NOT support `--allow-run-as-root`

### T2.7 — Existing entries still present (regression)
```
lookup_gotcha_tool("nonhydrostatic")
lookup_gotcha_tool("rigid lid")
lookup_gotcha_tool("DIAGNOSTICS_SIZE")
lookup_gotcha_tool("RBCS relaxation")
```
✓ Each returns ≥1 entry

---

## 3. get_namelist_structure_tool (new in v2026.02.5)

### T3.1 — Basic call
```
get_namelist_structure_tool()
```
✓ Top-level keys include: `data`, `data.eos`, `data.pkg`, `data.exf`,
  `data.diagnostics`, `data.obcs`, `data.gmredi`, `data.kpp`, `data.rbcs`, `eedata`
✓ `data` contains `PARM01`, `PARM02`, `PARM03`, `PARM04`, `PARM05`
✓ `data.eos` contains `EOS_PARM01`
✓ `eedata` contains `EEPARMS`
✓ All description strings are non-empty
✓ Top-level keys are in alphabetical order

### T3.2 — Descriptions are informative
Inspect a few specific entries:
✓ `data` / `PARM01` description refers to core or basic model parameters
✓ `data.obcs` / first group description mentions open boundary conditions

---

## 4. namelist_to_code_tool warning (new behaviour in v2026.02.5)

### T4.1 — Known parameter: no warning
```
namelist_to_code_tool("cg3dMaxIters")
```
✓ First result has `name` key (not `warning`)
✓ `namelist_group` present

### T4.2 — Internal variable: warning returned
```
namelist_to_code_tool("tauX")
```
✓ Returns list with exactly 1 entry
✓ That entry has a `warning` key (not `name`)
✓ Warning text mentions `search_code_tool` or `get_namelist_structure_tool`
✓ Warning mentions `tauX` by name

### T4.3 — Another internal variable
```
namelist_to_code_tool("uVel")
```
✓ Same pattern as T4.2 — one entry with `warning` key

---

## 5. Query normalisation (new in v2026.02.5)

camelCase and snake_case queries are now split before embedding.

### T5.1 — search_docs_tool with camelCase
```
search_docs_tool("rigidLid free surface")
```
✓ Top result is related to rigid lid / free surface / barotropic solver
✓ NOT something completely unrelated (e.g. SHELFICE remeshing would be a fail)

### T5.2 — search_docs_tool with snake_case
```
search_docs_tool("no_slip_bottom boundary condition")
```
✓ At least one result mentions "no-slip" or "bottom boundary" or "viscosity"

### T5.3 — search_docs_tool mixed
```
search_docs_tool("deltaT CFL time step stability")
```
✓ Results mention CFL or time step

### T5.4 — search_verification_tool with camelCase
```
search_verification_tool("nonHydrostatic rotating convection")
```
✓ Results are from nonhydrostatic or convection experiments
✓ Snippets contain recognisable namelist content (`.TRUE.`, parameter names)

---

## 6. Verification experiments (new in v2026.02.5)

### T6.1 — list_verification_experiments_tool
```
list_verification_experiments_tool()
```
✓ Returns ≥50 experiments
✓ Each entry has: `name`, `tutorial` (bool), `packages` (list),
  `domain_class`, `Nx`, `Ny`, `Nr`, `grid_type`, `nonhydrostatic`,
  `free_surface`, `eos_type`
✓ `tutorial_rotating_tank` present with `tutorial=True`
✓ At least one entry with `nonhydrostatic=True`
✓ At least one entry with `free_surface=False`
✓ At least one entry with `domain_class="atmosphere"`

### T6.2 — search_verification_tool
```
search_verification_tool("nonhydrostatic SIZE.h sNx sNy Nr", top_k=3)
```
✓ `file` fields are paths like `verification/.../code/SIZE.h`
✓ `snippet` contains actual Fortran PARAMETER content

### T6.3 — get_doc_source_tool for verification file
Use a file path from T6.2 (e.g. `verification/tutorial_rotating_tank/code/SIZE.h`):
```
get_doc_source_tool("<file from T6.2>", "<section from T6.2>")
```
✓ Returns `{file, section, total_lines, offset, lines}`
✓ `lines` contains recognisable Fortran content

---

## 7. Header file indexing (new in v2026.02.5)

### T7.1 — .h header searchable via search_docs_tool
```
search_docs_tool("MAX_OLX overlap buffer EXCH", top_k=5)
```
✓ At least one result has a `file` field ending in `.h`
  (e.g. `model/inc/SIZE.h`, `eesupp/inc/EXCH.h`)
✓ `snippet` contains Fortran PARAMETER declarations

### T7.2 — Header content readable via get_doc_source_tool
```
get_doc_source_tool("model/inc/SIZE.h", "SIZE.h")
```
✓ Returns actual Fortran with `sNx`, `sNy`, `Nr`, `MAX_OLX` declarations

---

## 8. Code navigation (regression)

### T8.1 — find + source
```
find_subroutines_tool("INI_PARMS")
get_source_tool("INI_PARMS", limit=20)
```
✓ Subroutine found; first 20 lines returned

### T8.2 — Callers / callees
```
get_callers_tool("CG3D")
```
✓ Non-empty list

### T8.3 — CPP requirements
```
get_cpp_requirements_tool("CG3D")
```
✓ Returns a list that includes `"ALLOW_NONHYDROSTATIC"`
✓ May also include `"TARGET_NEC_SX"` and `"NONLIN_FRSURF"` — these are
  real guards on code paths inside the CG3D source in the full MITgcm
  tree (NEC SX vectorisation variant, non-linear free-surface path).
  All three flags are correct.

### T8.4 — namelist_to_code known param
```
namelist_to_code_tool("deltaT")
```
✓ Returns ≥1 entry with `name` and `namelist_group` (no `warning`)

---

## 9. Domain knowledge tools (regression + template check)

### T9.1 — translate_lab_params_tool
```
translate_lab_params_tool(Lx=0.5, Ly=0.5, depth=0.2, Omega=1.0, delta_T=5.0,
                           Nx=64, Ny=64, Nz=20)
```
✓ Keys: `PARM01`, `EOS_PARM01`, `PARM04`, `derived`, `notes`
✓ `PARM01` contains `f0`
✓ `PARM04` contains `delX`, `delY`, `delZ`

### T9.2 — check_scales_tool
```
check_scales_tool(Lx=0.5, Ly=0.5, depth=0.2, Omega=1.0, delta_T=5.0,
                  dx=0.0078, dz=0.01, dt=0.5, U=0.01)
```
✓ Returns `numbers` dict and `flags` list
✓ No crash; at least one `info` or `warning` flag

### T9.3 — suggest_experiment_config_tool Dockerfile template
```
suggest_experiment_config_tool("rotating_convection")
```
✓ No `--allow-run-as-root` anywhere in the quickstart output
✓ `quickstart.dockerfile_amd64` contains `-mpi` in the genmake2 invocation
✓ `quickstart.dockerfile_arm64` contains `-mpi` in the genmake2 invocation
✓ `quickstart.build` references `Dockerfile.amd64` and `Dockerfile.arm64`
✓ No `uname`-based arch detection in the Dockerfiles

---

## Pass / fail summary

| # | Section | Blocker? |
|---|---------|----------|
| 1 | Workflow tool | Yes — first thing any user calls |
| 2 | Gotcha catalogue (new entries) | Yes — core new content |
| 3 | get_namelist_structure_tool | Yes — new tool |
| 4 | namelist_to_code warning | Yes — changed behaviour |
| 5 | Query normalisation | Yes — new behaviour |
| 6 | Verification experiments | Yes — new infrastructure |
| 7 | Header indexing | Yes — new index content |
| 8 | Code navigation | Yes — regression |
| 9 | Domain knowledge + Dockerfile template | Yes — regression + template fix |

All sections must pass for release.
